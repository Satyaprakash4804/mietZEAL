<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ZEAL 10.0 Registration | Mangalmay Group of Institutions</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: 'Inter', 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; line-height: 1.6; }
.container { max-width: 900px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); overflow: hidden; animation: slideUp 0.6s ease-out; }
@keyframes slideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
.header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 40px 30px; text-align: center; color: white; position: relative; }
.header h1 { font-size: clamp(1.8rem, 5vw, 2.5rem); font-weight: 700; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.2); display: flex; align-items: center; justify-content: center; gap: 10px; }
.header p { font-size: clamp(0.9rem, 2.5vw, 1.1rem); opacity: 0.95; font-weight: 300; }
.header-subtitle { font-size: 0.9rem; margin-top: 5px; opacity: 0.9; }
.banner-img { width: 100%; max-height: 850px; object-fit: cover; display: block; }
.banner-img.hidden { display: none; }
.form-content { padding: 30px; }
.notice { background: linear-gradient(135deg, #e0e7ff 0%, #f3e8ff 100%); padding: 20px; border-radius: 12px; margin-bottom: 30px; border-left: 4px solid #667eea; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.1); }
.notice-title { font-weight: 700; color: #4c1d95; margin-bottom: 8px; font-size: 1.1rem; display: flex; align-items: center; gap: 8px; }
.notice p { color: #5b21b6; font-size: 0.95rem; margin: 4px 0; padding-left: 20px; }
.notice strong { color: #4c1d95; }
.form-section { margin-bottom: 30px; animation: fadeIn 0.5s ease-out; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
.section-title { font-size: 1.3rem; font-weight: 700; color: #1f2937; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #e5e7eb; display: flex; align-items: center; gap: 10px; }
.form-grid { display: grid; grid-template-columns: 1fr; gap: 20px; }
@media (min-width: 768px) { .form-grid.two-col { grid-template-columns: 1fr 1fr; } }
.form-group { display: flex; flex-direction: column; }
label { font-weight: 600; color: #374151; margin-bottom: 8px; font-size: 0.95rem; }
.required::after { content: " *"; color: #ef4444; }
input[type="text"], select { width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 1rem; transition: all 0.3s ease; background: #f9fafb; }
input[type="text"]:focus, select:focus { outline: none; border-color: #667eea; background: white; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }
.events-container { display: grid; grid-template-columns: 1fr; gap: 12px; margin-top: 15px; }
@media (min-width: 640px) { .events-container { grid-template-columns: repeat(2, 1fr); } }
.event-card { background: #f9fafb; border: 2px solid #e5e7eb; border-radius: 10px; padding: 14px; transition: all 0.3s ease; cursor: pointer; position: relative; user-select: none; }
.event-card:hover { border-color: #667eea; background: #f3f4f6; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15); }
.event-card.selected { background: #ede9fe; border-color: #667eea; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2); }
.event-card input[type="checkbox"] { display: none; }
.event-label { display: flex; align-items: flex-start; gap: 12px; cursor: pointer; pointer-events: none; }
.checkbox-custom { width: 22px; height: 22px; border: 2px solid #9ca3af; border-radius: 6px; flex-shrink: 0; position: relative; transition: all 0.3s ease; margin-top: 2px; background: white; }
.event-card.selected .checkbox-custom { background: #667eea; border-color: #667eea; }
.event-card.selected .checkbox-custom::after { content: "‚úì"; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; font-size: 14px; font-weight: bold; }
.event-info { flex: 1; }
.event-name { font-weight: 600; color: #1f2937; font-size: 0.95rem; margin-bottom: 4px; }
.event-price { color: #059669; font-weight: 700; font-size: 0.9rem; }
.event-price.discounted { color: #dc2626; }
.event-price .original { text-decoration: line-through; color: #9ca3af; margin-left: 8px; font-size: 0.85rem; }
.category-options { margin-top: 12px; padding-left: 34px; }
.category-options label { display: flex; align-items: center; gap: 8px; margin: 8px 0; cursor: pointer; font-size: 0.9rem; font-weight: normal; }
.category-options input[type="radio"] { width: 18px; height: 18px; cursor: pointer; accent-color: #667eea; }
.total-section { background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); padding: 25px; border-radius: 12px; margin: 25px 0; text-align: center; box-shadow: 0 4px 12px rgba(5, 150, 105, 0.2); }
.total-label { font-size: 1rem; color: #065f46; font-weight: 600; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
.total-amount { font-size: 2.5rem; font-weight: 800; color: #047857; }
.qr-section { background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%); padding: 30px; border-radius: 12px; margin-top: 25px; text-align: center; border: 2px dashed #d1d5db; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
.qr-section h3 { color: #1f2937; margin-bottom: 20px; font-size: 1.4rem; font-weight: 700; }
.qr-container { width: 260px; height: 260px; background: white; margin: 20px auto; border-radius: 12px; border: 2px solid #e5e7eb; display: flex; align-items: center; justify-content: center; padding: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
.qr-container img { width: 100% !important; height: 100% !important; object-fit: contain !important; display: block; }
.qr-container canvas { display: block !important; margin: 0 auto !important; }
.upload-area { margin-top: 25px; }
.file-input-wrapper { position: relative; overflow: hidden; display: inline-block; width: 100%; max-width: 400px; margin: 15px auto 0; }
.file-input-label { display: flex; align-items: center; justify-content: center; gap: 10px; padding: 14px 24px; background: #f3f4f6; border: 2px dashed #9ca3af; border-radius: 10px; cursor: pointer; transition: all 0.3s ease; font-weight: 600; color: #4b5563; }
.file-input-label:hover { background: #e5e7eb; border-color: #667eea; transform: translateY(-2px); }
.file-input-wrapper input[type="file"] { position: absolute; left: -9999px; }
.file-name { margin-top: 10px; color: #059669; font-weight: 600; font-size: 0.9rem; }
.btn { width: 100%; padding: 16px 32px; border: none; border-radius: 12px; font-size: 1.1rem; font-weight: 700; cursor: pointer; transition: all 0.3s ease; margin-top: 25px; text-transform: uppercase; letter-spacing: 0.5px; }
.btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4); }
.btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5); }
.btn-primary:active { transform: translateY(0); }
.btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none !important; }
.hidden { display: none !important; }
.info-box { background: #fef3c7; border-left: 4px solid #f59e0b; padding: 15px; border-radius: 8px; margin-top: 15px; }
.info-box p { color: #92400e; font-size: 0.9rem; line-height: 1.6; }
.success-modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 1000; padding: 20px; animation: fadeIn 0.3s ease-out; }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
.success-content { background: white; padding: 50px 40px; border-radius: 25px; text-align: center; max-width: 500px; width: 100%; animation: scaleIn 0.4s ease-out; box-shadow: 0 25px 50px rgba(0,0,0,0.3); }
@keyframes scaleIn { from { opacity: 0; transform: scale(0.8); } to { opacity: 1; transform: scale(1); } }
.success-icon { width: 100px; height: 100px; margin: 0 auto 25px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 4rem; animation: bounce 0.6s ease-out 0.2s; box-shadow: 0 10px 25px rgba(5, 150, 105, 0.3); }
@keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-20px); } }
.success-content h2 { color: #059669; margin-bottom: 15px; font-size: 2rem; font-weight: 800; }
.success-content p { color: #6b7280; margin-bottom: 15px; font-size: 1.05rem; line-height: 1.6; }
.success-details { background: #f0fdf4; padding: 20px; border-radius: 12px; margin: 20px 0; border: 2px solid #86efac; }
.success-details p { color: #166534; font-weight: 600; margin: 8px 0; font-size: 0.95rem; }
.success-buttons { display: flex; gap: 15px; margin-top: 30px; }
.success-buttons .btn { margin-top: 0; flex: 1; }
.btn-secondary { background: #e5e7eb; color: #1f2937; }
.btn-secondary:hover { background: #d1d5db; }
.error-message { background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); color: #991b1b; padding: 15px 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #dc2626; font-weight: 600; display: flex; align-items: center; gap: 10px; }
.discount-badge { background: #fef3c7; color: #92400e; padding: 4px 10px; border-radius: 6px; font-size: 0.75rem; font-weight: 700; margin-left: 8px; text-transform: uppercase; letter-spacing: 0.3px; display: inline-block; }
.loading-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 999; }
.loading-spinner { width: 60px; height: 60px; border: 4px solid #f3f4f6; border-top: 4px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite; }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
@media (max-width: 640px) { .form-content { padding: 20px; } .header { padding: 30px 20px; } .total-amount { font-size: 2rem; } .qr-container { width: 220px; height: 220px; } }
@media (max-width: 480px) { .success-content { padding: 40px 25px; } .success-icon { width: 80px; height: 80px; font-size: 3rem; } .success-content h2 { font-size: 1.5rem; } .success-buttons { flex-direction: column; } }
</style>
</head>
<body>

{% if success %}
<div class="success-modal">
    <div class="success-content">
        <div class="success-icon">‚úì</div>
        <h2>Registration Successful! üéâ</h2>
        <p>Your registration for ZEAL 10.0 has been submitted successfully.</p>
        <div class="success-details">
            <p>üìã Registration ID: <strong>#{{ registration_id }}</strong></p>
            <p>üìß You will receive a confirmation email shortly</p>
            <p>‚úÖ Payment verification is in progress</p>
        </div>
        <p style="font-size: 0.9rem; color: #9ca3af; margin-top: 10px;">
            Thank you for registering! We'll review your payment and confirm your participation soon.
        </p>
        <div class="success-buttons">
            <button class="btn btn-primary" onclick="window.location.href='/'">Register Another</button>
        </div>
    </div>
</div>
{% endif %}

<div class="container">
    <div class="header">
        <h1>üéØ ZEAL 10.0</h1>
        <p>Mangalmay Group of Institutions</p>
        <p class="header-subtitle">Student Competition Registration</p>
    </div>
    
    {% if banner_exists %}
    <img src="{{ url_for('static', filename='images/zeal_banner.jpeg') }}" 
         alt="ZEAL 10.0 Banner" 
         class="banner-img" 
         onerror="this.style.display='none'">
    {% endif %}
    
    <div class="form-content">
        {% if error %}
        <div class="error-message">
            <span>‚ö†Ô∏è</span>
            <span>{{ error }}</span>
        </div>
        {% endif %}

        <div class="notice">
            <div class="notice-title">üì¢ Important Information</div>
            <p>‚úì Students may select <strong>more than one event</strong></p>
            <p>‚úì Complete payment using the generated QR code</p>
            <p>‚úì Upload payment screenshot after successful payment</p>
        </div>

        <form method="POST" enctype="multipart/form-data" id="registrationForm">
            <input type="hidden" name="step" id="stepInput" value="form">

            <div class="form-section">
                <h2 class="section-title">üë§ Personal Information</h2>
                <div class="form-grid two-col">
                    <div class="form-group">
                        <label class="required">Student Name</label>
                        <input type="text" name="student_name" id="student_name" value="{{ form_data.get('student_name', '') }}" required>
                    </div>
                    <div class="form-group">
                        <label class="required">University Roll No.</label>
                        <input type="text" name="roll_no" id="roll_no" value="{{ form_data.get('roll_no', '') }}" required>
                    </div>
                </div>
                <div class="form-group" style="margin-top: 20px;">
                    <label class="required">Course</label>
                    <input type="text" name="course" id="course" value="{{ form_data.get('course', '') }}" placeholder="e.g., B.Tech CSE, BBA, MBA" required>
                </div>
            </div>

            <div class="form-section">
                <h2 class="section-title">üè´ College Information</h2>
                <div class="form-group">
                    <label class="required">Select College</label>
                    <select name="college" id="college" required>
                        <option value="">-- Select Your College --</option>
                        <option {% if form_data.get('college') == 'Mangalmay Group of Institutions' %}selected{% endif %}>Mangalmay Group of Institutions</option>
                        <option {% if form_data.get('college') == 'Amity University, Greater Noida' %}selected{% endif %}>Amity University, Greater Noida</option>
                        <option {% if form_data.get('college') == 'Bennett University' %}selected{% endif %}>Bennett University</option>
                        <option {% if form_data.get('college') == 'Birla Institute of Management Technology (BIMTECH)' %}selected{% endif %}>Birla Institute of Management Technology (BIMTECH)</option>
                        <option {% if form_data.get('college') == 'Galgotias College of Engineering and Technology (GCET)' %}selected{% endif %}>Galgotias College of Engineering and Technology (GCET)</option>
                        <option {% if form_data.get('college') == 'Gautam Buddha University' %}selected{% endif %}>Gautam Buddha University</option>
                        <option {% if form_data.get('college') == 'G L Bajaj Institute Of Engineering Technology' %}selected{% endif %}>G L Bajaj Institute Of Engineering Technology</option>
                        <option {% if form_data.get('college') == 'Global Institute Of Information Technology' %}selected{% endif %}>Global Institute Of Information Technology</option>
                        <option {% if form_data.get('college') == 'Greater Noida Institute of Technology (GNIT)' %}selected{% endif %}>Greater Noida Institute of Technology (GNIT)</option>
                        <option {% if form_data.get('college') == 'IIMT College' %}selected{% endif %}>IIMT College</option>
                        <option {% if form_data.get('college') == 'IILM University, Greater Noida' %}selected{% endif %}>IILM University, Greater Noida</option>
                        <option {% if form_data.get('college') == 'I.T.S Engineering College' %}selected{% endif %}>I.T.S Engineering College</option>
                        <option {% if form_data.get('college') == 'KCC Institute of Technology and Management' %}selected{% endif %}>KCC Institute of Technology and Management</option>
                        <option {% if form_data.get('college') == 'Lloyd Business School' %}selected{% endif %}>Lloyd Business School</option>
                        <option {% if form_data.get('college') == 'Noida Institute of Engineering and Technology' %}selected{% endif %}>Noida Institute of Engineering and Technology</option>
                        <option {% if form_data.get('college') == 'Noida International University (NIU)' %}selected{% endif %}>Noida International University (NIU)</option>
                        <option {% if form_data.get('college') == 'Sharda University' %}selected{% endif %}>Sharda University</option>
                        <option {% if form_data.get('college') == 'United College of Engineering and Research' %}selected{% endif %}>United College of Engineering and Research</option>
                        <option {% if form_data.get('college') == 'Other' %}selected{% endif %}>Other</option>
                    </select>
                </div>

                <div id="college_id_box" class="form-group {% if form_data.get('college') != 'Mangalmay Group of Institutions' %}hidden{% endif %}" style="margin-top: 20px;">
                    <label class="required">Mangalmay College ID</label>
                    <input type="text" name="college_id" id="college_id" value="{{ form_data.get('college_id', '') }}" placeholder="Enter your Mangalmay ID">
                    <div class="discount-badge" style="margin-top: 10px; display: inline-block;">üéâ 50% Discount Applied</div>
                </div>

                <div id="other_college_box" class="form-group {% if form_data.get('college') != 'Other' %}hidden{% endif %}" style="margin-top: 20px;">
                    <label class="required">Enter College Name</label>
                    <input type="text" name="other_college" id="other_college" value="{{ form_data.get('other_college', '') }}" placeholder="Type your college name">
                </div>
            </div>

            <div class="form-section">
                <h2 class="section-title">üé™ Event Selection</h2>
                <div class="events-container" id="eventsContainer"></div>
            </div>

            <div class="form-section">
                <h2 class="section-title">‚ÑπÔ∏è Additional Information</h2>
                <div class="form-group">
                    <label>Group Members (Optional)</label>
                    <input type="text" name="group_members" id="group_members" value="{{ form_data.get('group_members', '') }}" placeholder="Enter names separated by commas (for group events)">
                </div>
                <div class="form-group" style="margin-top: 20px;">
                    <label class="required">Contact Numbers</label>
                    <input type="text" name="contact_numbers" id="contact_numbers" value="{{ form_data.get('contact_numbers', '') }}" placeholder="Enter phone numbers separated by commas" required>
                </div>
                <div class="info-box">
                    <p><strong>üí° Note:</strong> For group events, please provide all team member names and contact numbers separated by commas.</p>
                </div>
            </div>

            <div class="total-section">
                <div class="total-label">Total Registration Amount</div>
                <div class="total-amount">‚Çπ<span id="totalAmount">{{ total if total else 0 }}</span></div>
            </div>

            <button type="button" class="btn btn-primary" id="generateQrBtn" onclick="generateQR()">
                üîê Generate Payment QR Code
            </button>

            <div id="qrSection" class="qr-section {% if not qr %}hidden{% endif %}">
                <h3>üí≥ Scan & Pay with Any UPI App</h3>
                <div class="qr-container" id="qrContainer">
                    {% if qr %}
                    <img src="{{ url_for('static', filename='qr/' + qr) }}" 
                         alt="Payment QR Code" 
                         id="qrImage"
                         onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iI2YwZjBmMCIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTYiIGZpbGw9IiM2NjY2NjYiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj5RUiBDb2RlPC90ZXh0Pjwvc3ZnPg=='">
                    {% endif %}
                </div>
                <p style="color: #059669; font-weight: 700; font-size: 1.2rem; margin: 15px 0;">
                    üí∞ Amount: ‚Çπ<span id="qrAmount">{{ total if total else 0 }}</span>
                </p>
                <p style="color: #6b7280; font-size: 0.9rem; font-weight: 600;">
                    UPI ID: <span style="font-family: 'Courier New', monospace; color: #059669;">mangalmayinstituteof.69356291@hdfcbank</span>
                </p>

                <div class="upload-area">
                    <label style="font-weight: 600; color: #1f2937; font-size: 1rem;">üì∏ Upload Payment Screenshot</label>
                    <div class="file-input-wrapper">
                        <label for="payment_screenshot" class="file-input-label">
                            <span>üìé</span>
                            <span>Choose Screenshot</span>
                        </label>
                        <input type="file" name="payment_screenshot" id="payment_screenshot" accept="image/*" required>
                    </div>
                    <div id="fileName" class="file-name"></div>
                </div>

                <button type="button" class="btn btn-primary" onclick="submitFinalForm()" id="submitBtn">
                    ‚úÖ Submit Registration
                </button>
            </div>
        </form>
    </div>
</div>

<div id="loadingOverlay" class="loading-overlay hidden">
    <div class="loading-spinner"></div>
</div>

<script>
/* =========================================================
   EVENTS FROM BACKEND
========================================================= */
const backendEvents = {{ events | default({}) | tojson | safe }};
const grouped = {};
const simpleEvents = [];

Object.entries(backendEvents).forEach(([name, price]) => {
    if (name.includes(" - ")) {
        const [parent, category] = name.split(" - ");
        if (!grouped[parent]) grouped[parent] = [];
        grouped[parent].push({ name: category, price });
    } else {
        simpleEvents.push({ name, price });
    }
});

const events = [
    ...simpleEvents,
    ...Object.keys(grouped).map(parent => ({
        name: parent,
        price: null,
        categories: grouped[parent]
    }))
];

/* =========================================================
   EVENT RENDERING (FIXED)
========================================================= */
const selectedEventsFromServer = {{ selected_events | default([]) | tojson | safe }};
const container = document.getElementById('eventsContainer');

events.forEach(event => {
    const card = document.createElement('div');
    card.className = 'event-card';

    if (event.categories) {
        const radioGroupName = `category_${event.name.replace(/[^a-zA-Z0-9]/g,'_')}`;

        card.innerHTML = `
            <input type="checkbox"
                   name="events"
                   value="${event.name}"
                   data-has-categories="true">

            <label class="event-label">
                <div class="checkbox-custom"></div>
                <div class="event-info">
                    <div class="event-name">${event.name}</div>
                </div>
            </label>

            <div class="category-options" style="display:none;">
                ${event.categories.map(cat=>`
                    <label>
                        <input type="radio"
                               class="category-radio"
                               name="${radioGroupName}"
                               value="${cat.name}"
                               data-price="${cat.price}">
                        ${cat.name} ‚Äì ‚Çπ${cat.price}
                    </label>
                `).join('')}
                
            </div>
        `;
    } else {
        card.innerHTML = `
            <input type="checkbox"
                   name="events"
                   value="${event.name}"
                   data-price="${event.price}">

            <label class="event-label">
                <div class="checkbox-custom"></div>
                <div class="event-info">
                    <div class="event-name">${event.name}</div>
                    <div class="event-price">‚Çπ${event.price}</div>
                </div>
            </label>
        `;
    }

    /* ---------- CLICK HANDLING ---------- */
    card.addEventListener('click', e => {

        /* If radio clicked ‚Üí only recalc total */
        if (e.target.classList.contains('category-radio')) {
            updateTotal();
            e.stopPropagation();
            return;
        }

        const checkbox = card.querySelector('input[type="checkbox"]');
        const categoryBox = card.querySelector('.category-options');

        checkbox.checked = !checkbox.checked;
        card.classList.toggle('selected', checkbox.checked);

        if (categoryBox) {
            categoryBox.style.display = checkbox.checked ? 'block' : 'none';
        }

        updateTotal();
    });

    /* ---------- RADIO CHANGE SAFETY ---------- */
    card.querySelectorAll('input[type="radio"]').forEach(radio => {
        radio.addEventListener('change', updateTotal);
    });

    container.appendChild(card);

    /* ---------- RESTORE SELECTION FROM SERVER ---------- */
    selectedEventsFromServer.forEach(sel => {
        const [ev, cat] = sel.split(" - ");
        if (ev === event.name) {
            const checkbox = card.querySelector('input[type="checkbox"]');
            checkbox.checked = true;
            card.classList.add('selected');

            const categoryBox = card.querySelector('.category-options');
            if (categoryBox) {
                categoryBox.style.display = 'block';
                if (cat) {
                    const radio = [...categoryBox.querySelectorAll('input[type="radio"]')]
                        .find(r => r.value === cat);
                    if (radio) radio.checked = true;
                }
            }
        }
    });
});

setTimeout(updateTotal, 0);
/* =========================================================
   VALIDATION (MANDATORY FIELDS)
========================================================= */
function validateForm(beforeFinal=false) {

    const requiredFields = [
        student_name,
        roll_no,
        course,
        college,
        contact_numbers
    ];

    for (const field of requiredFields) {
        if (!field.value.trim()) {
            alert("‚ö†Ô∏è Please fill all mandatory fields!");
            field.focus();
            return false;
        }
    }

    if (college.value === 'Mangalmay Group of Institutions' && !college_id.value.trim()) {
        alert("‚ö†Ô∏è Please enter Mangalmay College ID!");
        college_id.focus();
        return false;
    }

    if (college.value === 'Other' && !other_college.value.trim()) {
        alert("‚ö†Ô∏è Please enter college name!");
        other_college.focus();
        return false;
    }

    const selectedEvents = document.querySelectorAll('input[name="events"]:checked');
    if (!selectedEvents.length) {
        alert("‚ö†Ô∏è Please select at least one event!");
        return false;
    }

    for (const cb of selectedEvents) {
        if (cb.dataset.hasCategories) {
            const card = cb.closest('.event-card');
            if (!card.querySelector('input[type="radio"]:checked')) {
                alert("‚ö†Ô∏è Please select category for all selected events!");
                return false;
            }
        }
    }

    if (beforeFinal) {
        if (!payment_screenshot.files[0]) {
            alert("‚ö†Ô∏è Please upload payment screenshot!");
            return false;
        }

        const file = payment_screenshot.files[0];
        const size = file.size / 1024 / 1024;
        if (size > 5) {
            alert("‚ö†Ô∏è Screenshot must be under 5MB!");
            return false;
        }

        if (!['image/png','image/jpeg','image/jpg'].includes(file.type)) {
            alert("‚ö†Ô∏è Invalid image format!");
            return false;
        }
    }

    return true;
}

function handleCollegeChange() {
    const collegeValue = college.value;
    const isMGI = collegeValue === 'Mangalmay Group of Institutions';

    college_id_box.classList.toggle('hidden', !isMGI);
    college_id.required = isMGI;

    other_college_box.classList.toggle('hidden', collegeValue !== 'Other');
    other_college.required = collegeValue === 'Other';

    updateTotal();
}

college.addEventListener('change', handleCollegeChange);

document.addEventListener('DOMContentLoaded', () => {
    handleCollegeChange();
    updateTotal();
});

/* =========================================================
   TOTAL
========================================================= */
function updateTotal() {
    let total = 0;
    const isMGI = college.value === 'Mangalmay Group of Institutions';

    document.querySelectorAll('.event-card').forEach(card => {
        const checkbox = card.querySelector('input[type="checkbox"]');

        if (!checkbox || !checkbox.checked) return;

        // CATEGORY BASED EVENT
        if (checkbox.dataset.hasCategories === "true") {
            const radios = card.querySelectorAll('input[type="radio"]');
            let selectedRadio = null;

            radios.forEach(r => {
                if (r.checked) selectedRadio = r;
            });

            if (!selectedRadio) return;

            let price = parseInt(selectedRadio.dataset.price, 10);
            total += isMGI ? price / 2 : price;
        }

        // SIMPLE EVENT
        else {
            let price = parseInt(checkbox.dataset.price, 10);
            total += isMGI ? price / 2 : price;
        }
    });

    totalAmount.textContent = total;
    if (typeof qrAmount !== 'undefined' && qrAmount) {
        qrAmount.textContent = total;
    }
}

/* =========================================================
   QR & FINAL SUBMIT
========================================================= */
function generateQR() {
    if (!validateForm(false)) return;
    stepInput.value = 'qr';
    registrationForm.submit();
}

function submitFinalForm() {
    if (!validateForm(true)) return;
    stepInput.value = 'final';
    registrationForm.submit();
}

payment_screenshot.addEventListener('change', e => {
    if (e.target.files[0]) fileName.innerHTML = `‚úì ${e.target.files[0].name}`;
});

college.addEventListener('change', updateTotal);
document.addEventListener('DOMContentLoaded', updateTotal);
</script>




</body>
</html>
